# Logs for Using GROMACS

# Control: Rolipram in Water

* Lysozyme Tutorial: [Lysozyme](http://www.mdtutorials.com/gmx/lysozyme/index.html)

* Another Tutorial: [Molecular Dynamics simulation of a protein in water environment](https://www.compchems.com/gromacs-tutorial-molecular-dynamics-simulation-of-a-protein-in-water-environment/#protein-selection-and-initial-setup)
* RMSF Calculation: [Obtain RMSF vs residue number using GROMACS](https://www.compchems.com/how-to-compute-the-rmsf-using-gromacs/)



### Index of files:
 
1. Rolipram protein PDB file: Provided
2. MDP file for generating ions tpr: http://www.mdtutorials.com/gmx/lysozyme/Files/ions.mdp
3. MDP file for energy minimization: 
    * Original: http://www.mdtutorials.com/gmx/lysozyme/Files/minim.mdp
    * Modified: [minim.mdp](minim.mdp)
4. MDP file for NVT equilibriation: http://www.mdtutorials.com/gmx/lysozyme/Files/nvt.mdp
5. MDP file for NPT equilibriation: http://www.mdtutorials.com/gmx/lysozyme/Files/npt.mdp
6. MDP file for actual production MD: http://www.mdtutorials.com/gmx/lysozyme/Files/md.mdp

## Steps for running with OPLS force field (Same as MMP2 protein):

Main problem: Unknown ligand, gromacs cannot automatically make topology.

1. Got ligand PDB file
2. Used PyMol to add all hydrogen atoms to PDB file and save as new PDB file
3. Upload latest PDB file to [LigParGen server](http://zarbi.chem.yale.edu/ligpargen/). Output was gro and itp files with unknown residue labelled as "UNL". Renamed gro file but kept itp file as is.
4. Got a generic topol file from [researchgate](https://www.researchgate.net/post/How_to_generate_top_file_for_Gromacs) . Replaced "DRG" by "UNL"
5. Included the itp file generated by LigParGen in the topol.top file as:
    ```bash
    ; Include drug topologies
    #include "UNL_F78916.itp"
    ```
    below the inclusion of OPLS forcefield file 
6. Added cubic box using 'gmx editconf'. Manually altered the box dimensions in the gro file to match that of the MMP2 box (cubic box: last line has Lx Ly Lz in nm)
7. Solvated with water using 'gmx solvate'
8. Tried to neutralize spurious charges with Na and Cl ions: Didn't work, as the net charge is very small: 0.0003. Ignoring for now, but there may be artifacts.
9. gmx grompp for EM gave warning and crashed as the system is not fulyl neutral. Reran with -maxwarn 2 flag.
10. Ran steepest descent minimization of energy. Converged pretty well on my laptop with 12 openmp threads.
11. Now, time for NVT equilibrium. Running with the standard mdp file for nvt from the protein simulation resulted in an error, since the tc-grps settings that govern which atom groups are to be coupled to the temperature bath were for "Protein" and "Non-protein" (there is no protein here, only the ligand). So changed it to "System" to couple everything (incl the water solvent-> may be slow). Also, no position restraints on protein (since there is no protein)
```diff
diff --git a/MMP2_Rolipram/Rolipram/nvt.mdp b/MMP2_Rolipram/Rolipram/nvt.mdp
index 17881f8..3c64f2e 100644
--- a/MMP2_Rolipram/Rolipram/nvt.mdp
+++ b/MMP2_Rolipram/Rolipram/nvt.mdp
@@ -1,5 +1,5 @@
-title                   = OPLS Lysozyme NVT equilibration 
-define                  = -DPOSRES  ; position restrain the protein
+title                   = OPLS Rolipram NVT equilibration 
+define                  = -DPOSRES  ; position restrain the ligand
 ; Run parameters
 integrator              = md        ; leap-frog integrator
 nsteps                  = 50000     ; 2 * 50000 = 100 ps
@@ -28,9 +28,9 @@ pme_order               = 4         ; cubic interpolation
 fourierspacing          = 0.16      ; grid spacing for FFT
 ; Temperature coupling is on
 tcoupl                  = V-rescale             ; modified Berendsen thermostat
-tc-grps                 = Protein Non-Protein   ; two coupling groups - more accurate
-tau_t                   = 0.1     0.1           ; time constant, in ps
-ref_t                   = 300     300           ; reference temperature, one for each group, in K
+tc-grps                 = System               ; This couples all molecules (incl the water) to the bath
+tau_t                   = 0.1                   ; time constant, in ps
+ref_t                   = 300                   ; reference temperature, one for each group, in K
 ; Pressure coupling is off
 pcoupl                  = no        ; no pressure coupling in NVT
 ; Periodic boundary conditions

```


In addition, running mdrun without position restraints results in rather large Center-of-mass motion (as seen with [VMD Visualizer](https://www.ks.uiuc.edu/Research/vmd/) on the gro/trr files), so we restrain the heavier atoms as follows:

* First, create an index group for Rolipram that contains only its non-hydrogen atoms:

   ```bash
   $ gmx make_ndx -f rol.gro -o index_rol.ndx
   ...
   > 0 & ! a H*
   > q
   ```

* Then, execute the genrestr module and select this newly created index group (which will be group 3 in the index_rol.ndx file)::

    ```bash
    $ gmx genrestr -f rol.gro -n index_rol.ndx -o posre_rol.itp -fc 1000 1000 1000
    ```


* Now, we need to include this information in our topology. Add the following lines to your topology **in the location indicated**:

```diff
diff --git a/MMP2_Rolipram/Rolipram/topol.top b/MMP2_Rolipram/Rolipram/topol.top
index b199128..6912c2a 100644
--- a/MMP2_Rolipram/Rolipram/topol.top
+++ b/MMP2_Rolipram/Rolipram/topol.top
@@ -2,6 +2,10 @@
 #include "oplsaa.ff/forcefield.itp"
 ; Include drug topologies
 #include "UNL_F78916.itp"
+; Ligand position restraints
+#ifdef POSRES
+#include "posre_rol.itp"
+#endif
 ; Include water topology
 #include "oplsaa.ff/spc.itp"
 #ifdef POSRES_WATER
```


* Finally, pre-process for nvt with:

   ```bash
    $ gmx grompp -f nvt.mdp -c em.gro -r em.gro -p topol.top -o nvt.tpr -maxwarn 2
   ```

* And run the mdrun the usual way, then get pressure, temperature and total energy just like in the lysozyme tutorial.




12. Now, run the NPT equilibriation. The MMP2 mdp file for npt was modified thus:

```diff
1,2c1,2
< title                   = OPLS Lysozyme NPT equilibration 
< define                  = -DPOSRES  ; position restrain the protein
---
> title                   = OPLS Ligand NPT equilibration 
> define                  = -DPOSRES  ; position restrain the ligand
31,33c31,33
< tc-grps                 = Protein Non-Protein   ; two coupling groups - more accurate
< tau_t                   = 0.1     0.1           ; time constant, in ps
< ref_t                   = 300     300           ; reference temperature, one for each group, in K
---
> tc-grps                 = System              ; The whole system is now coupled
> tau_t                   = 0.1                   ; time constant, in ps
> ref_t                   = 300                   ; reference temperature, one for each group, in K
```
Standard pre-processing and mdrun was run

TODO:

1. Run NVT and NPT equilibriation
2. Production MD from NPT equilibrium. 100 ns
3. Post processing: Obtained RMSD and Radius of Gyration. New quantity (RMSF) as a function of residue number was also obtained.

