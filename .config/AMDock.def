Bootstrap: library   
From: ubuntu:22.04
Stage: build

%labels
  APPLICATION AMDock
  AUTHOR Analabha Roy
  EMAIL daneel@utexas.edu
  YEAR 2025

%files

%environment
  TZ=UTC
  DEBIAN_FRONTEND=noninteractive
  CUDACXX=/usr/local/cuda/bin/nvcc
  PATH=$PATH:/usr/local/cuda/bin:/usr/local/bin
  LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda-12.4/targets/x86_64-linux/lib:/usr/local/cuda-12.4/lib64:/usr/local/lib
  export TZ=UTC
  export DEBIAN_FRONTEND=noninteractive
  export CUDACXX=/usr/local/cuda/bin/nvcc
  export PATH=$PATH:/usr/local/cuda/bin:/usr/local/bin
  export LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda-12.4/targets/x86_64-linux/lib:/usr/local/cuda-12.4/lib64:/usr/local/lib

%runscript
  #!/bin/bash
  export TZ=UTC
  export DEBIAN_FRONTEND=noninteractive
  export TZ=UTC
  export DEBIAN_FRONTEND=noninteractive
  export CUDACXX=/usr/local/cuda/bin/nvcc
  export PATH=$PATH:/usr/local/cuda/bin:/usr/local/bin
  export LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda-12.4/targets/x86_64-linux/lib:/usr/local/cuda-12.4/lib64:/usr/local/lib
  exec AMDock "$@"

%post
  export VINA_URL="https://github.com/ccsb-scripps/AutoDock-Vina/releases/download/v1.2.7/vina_1.2.7_linux_x86_64"
  export VINA_SPLIT_URL="https://github.com/ccsb-scripps/AutoDock-Vina/releases/download/v1.2.7/vina_split_1.2.7_linux_x86_64"
  export CUDAPIN_URL="https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin"
  export UBUNTU_VER="ubuntu2204"
  export CUDAVERSION="12-4"
  export CUDAVERSIONNUM="12"
  export CUDAREPO_URL="https://developer.download.nvidia.com/compute/cuda/12.4.0/local_installers/cuda-repo-ubuntu2204-12-4-local_12.4.0-550.54.14-1_amd64.deb"
  export CUDADEB="cuda-repo-ubuntu2204-12-4-local_12.4.0-550.54.14-1_amd64.deb"

  export CUDNN_URL="https://developer.download.nvidia.com/compute/cudnn/9.0.0/local_installers/cudnn-local-repo-ubuntu2204-9.0.0_1.0-1_amd64.deb"
  export CUDNN_DEB="cudnn-local-repo-ubuntu2204-9.0.0_1.0-1_amd64.deb"
  export CUDNNVER="9.0.0"

  export MINIFORGE_URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh"
  export CMAKEURL="https://github.com/Kitware/CMake/releases/download/v3.31.7/cmake-3.31.7-linux-x86_64.sh"


  export TZ=UTC
  export DEBIAN_FRONTEND=noninteractive
  export CUDACXX=/usr/local/cuda/bin/nvcc
  export PATH=$PATH:/usr/local/cuda/bin:/usr/local/bin
  export LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/cuda-12.4/targets/x86_64-linux/lib:/usr/local/cuda-12.4/lib64:/usr/local/lib

  mkdir -p /usr/src
  # Update, install and cleanup of system packages needed at run-time
  apt-get update -y
  apt-get upgrade -y
  apt-get -y install xauth build-essential wget ca-certificates git dos2unix zsh libboost-all-dev libeigen3-dev libgoogle-glog-dev libprotobuf-dev protobuf-compiler libhdf5-dev libatlas-base-dev libjsoncpp-dev swig
  
  # Add NVIDIA package repositories
  wget $CUDAPIN_URL
  mv cuda-$UBUNTU_VER.pin /etc/apt/preferences.d/cuda-repository-pin-600
  wget $CUDAREPO_URL
  dpkg -i $CUDADEB
  rm $CUDADEB
  # Add the keyring
  cp /var/cuda-repo-$UBUNTU_VER-$CUDAVERSION-local/cuda-*-keyring.gpg /usr/share/keyrings/
  apt-get update -y

  # Install CUDA 12.4
  apt-get -y install cuda-$CUDAVERSION

  # Install cudnn 9.0.0
  wget $CUDNN_URL
  dpkg -i $CUDNN_DEB
  rm $CUDNN_DEB
  cp /var/cudnn-local-repo-$UBUNTU_VER-$CUDNNVER/cudnn-*-keyring.gpg /usr/share/keyrings/
  apt-get update -y
  apt-get -y install cudnn-cuda-$CUDAVERSIONNUM

  # Install Miniforge3
  wget $MINIFORGE_URL -O Miniforge3-Linux-x86_64.sh
  /bin/bash ./Miniforge3-Linux-x86_64.sh -bfp /usr/local
  conda config --file /.condarc --add channels defaults
  conda config --file /.condarc --add channels conda-forge
  conda config --file /.condarc --add channels bioconda
  conda config --file /.condarc --add channels salilab
  conda update conda -y
  conda update mamba -y
  rm Miniforge3-Linux-x86_64.sh

  # Downgrade Python to 3.9.20
  conda install -y python=3.9.20
  pip3 install --upgrade pip

  # Install MPI and AMDock
  mamba install -c bioconda -c conda-forge -c salilab -y pymol-open-source pdb2pqr mpi4py rdkit biopython numpy autodock autodock-vina scipy matplotlib seaborn pandas scikit-learn ipywidgets ipython ipykernel nbconvert nbformat terminado traitlets json5 glob2 requests pydot pydotplus py3Dmol nb_conda_kernels pytest
  python3 -m pip install pdb2pqr PyQt5
  python3 -m pip install git+https://github.com/Valdes-Tresanco-MS/AutoDockTools_py3
  python3 -m pip install AMDock
  python3 -m pip install importmonkey

  # Download and install pre-compiled release of AutoDock Vina
  wget $VINA_URL -O /usr/local/bin/vina
  chmod +x /usr/local/bin/vina
  wget $VINA_SPLIT_URL -O /usr/local/bin/vina_split
  chmod +x /usr/local/bin/vina_split
  
  # Install the latest CMake 3.0
  wget $CMAKEURL -O cmake-3.31.7-linux-x86_64.sh
  chmod +x cmake-3.31.7-linux-x86_64.sh
  ./cmake-3.31.7-linux-x86_64.sh --skip-license --prefix=/usr/local
  rm cmake-3.31.7-linux-x86_64.sh
 
  # Install OpenBabel3. Note there are errors in bond order determination in version 3.1.1 and older.
  cd /usr/src/
  git clone https://github.com/openbabel/openbabel.git
  cd openbabel
  mkdir build
  cd build
  cmake -DWITH_MAEPARSER=OFF -DWITH_COORDGEN=OFF -DPYTHON_BINDINGS=ON -DRUN_SWIG=ON ..
  make -j8
  make install
  
  # Install gnina
  export CUDACXX=/usr/local/cuda/bin/nvcc
  export PATH=$PATH:/usr/local/cuda/bin
  cd /usr/src/
  git clone https://github.com/gnina/gnina.git
  cd gnina
  mkdir build
  cd build
  cmake -DCMAKE_CUDA_ARCHITECTURES=all ..
  make -j8
  make install
  
  # Cleanup unnecessary files to reduce image size
  mamba clean -y --all
  pip cache purge
  rm -rf /var/lib/apt/lists/*
  apt-get clean
  rm -rf /root/.cache
  rm -rf /usr/local/pkgs
  rm -rf /usr/src/openbabel
  rm -rf /usr/src/gnina
